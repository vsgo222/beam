---
title: "BEAM Event Handler"
author: "Hayden Atchley"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
geometry: margin=1in
output:
  html_document:
    toc: false
  pdf_document:
    latex_engine: lualatex
    includes:
      in_header: "preamble.tex"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r load_packages, include=FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  pacman,
  tidyverse,
  flextable,
  knitr,
  magrittr,
  devtools,
  namer,
  kableExtra
  )
if(!require(packageSHA)) install_github("atchley-sha/R-packageSHA")
library(packageSHA)
```


\RaggedRight


LOADING THE DATA
================================

BEAM can be configured to output an `events.csv` file for each iteration. For now, I just picked one for testing:
```{r}
eventsCSV = "R/eventHandler/test/39.events.csv"
```

I then loaded the .csv file, Unfortunately, `read_csv` didn't get all the data types right, so I had to set them manually:
```{r}
coltypes <- paste0("cdcdcccddd",
                   "cddddddddc",
                   "dcccdddddc",
                   "cdcccdldcc",
                   "ccccddcddc",
                   "cccc"
                   )

fullEvents <- read_csv(eventsCSV, col_types = coltypes)
```

**NOTE** I am in the process of creating a list with each column name and type in case the column order changes or different columns are written. It is not yet finished however.

Then I selected a few columns of interest, and added a couple more:
```{r}
eventCols <- c("person",
               "time",
               "type",
               "mode",
               "legMode",
               "vehicleType",
               "vehicle",
               "arrivalTime",
               "departureTime",
               "departTime",
               "length",
               "numPassengers",
               "actType",
               "personalVehicleAvailable"
               )
fullEvents %<>% relocate(all_of(eventCols))

events <- fullEvents %>% select(all_of(eventCols))
events %<>% mutate(
  travelTime = arrivalTime - departureTime,
  avgSpeed = length / travelTime
)
events %<>% arrange(person, time)
```

**TODO:** I will work on code to read in various information from the rhFleet file like shift duration, etc. That info can be important for stats like utilization (passengers/hour/vehicle). For now, I just took the actual values:
```{r}
rhHours <- 80000/3600 #add code to read from the file
rhNum <- 12
```

I also loaded some stats from UTA On Demand's monthly reports (the data is available in quarterly reports, I created the csv):
```{r}
UTAOD <- read_csv("R/eventHandler/test/UTAODpilotinfo.csv")
UTAOD %>%
  my_kbl(digits = 3, align = 'lrrr')
```

As a side note, I stored some person IDs that provide useful demonstrations:
```{r}
personRH <- 1067049  #normal ridehail
personRH2 <- 730554   #rh2
personReplan <- 1060618  #rh replanning
personModefail <- 1023248 #mode isn't realized by end of simulation
```


ANALYSIS
============================

### Event Types

A good place to start is with the event types:
```{r}
countEvents <- events %>%
  group_by(type) %>%
  summarize(n = n())
countEvents %>%
  my_kbl(align = 'lr')
```

Many of these are self-explanatory, but here is what I've gathered so far:

- `actstart`/`actend` list the person, time, and type of event
- `arrival`/`departure` list the person, time, and "legmode"
  * `legmode` according to the BEAM documentation is the overall trip mode, either realized (`arrival`) or to be attempted (`departure`)
- `PersonEntersVehicle`/`PersonLeavesVehicle` lists the person, vehicle, and time
- `ReserveRideHail` just lists the person and time
- `ModeChoice` lists the person, time, mode desired, length (distance) of intended trip, and if a personal vehicle was available when the mode choice was made
- `Replanning` just lists the person and time; I believe this is triggered when the original mode choice didn't work for whatever reason, so the agent chooses a different mode (in a subsequent `ModeChoice` event)
- `PathTraversal` is an event for vehicles rather than for agents. It lists time, mode, vehicle type, vehicle, departure time, arrival time, length (distance), and number of passengers. It also lists comma-separated IDs of the links traversed. It does not list the person IDs of the passengers, but may be useful for stats like average trip time. However, these events relate to *sub-legs* of the trip, rather than the overall trip. I believe when it comes to transit modes there is one event per stop, based on the travel time of each such event.

We can see the mode choice distribution, as well as the legmode of `arrival` events:
```{r}
modechoice <- events %>%
  filter(type == "ModeChoice") %>%
  group_by(mode) %>%
  summarize(n = n())

legMode <- events %>%
  filter(!is.na(legMode),
         type == "arrival") %>%
  group_by(legMode) %>%
  summarise(n = n())

modeComparison <- left_join(modechoice,
          legMode,
          by = c("mode" = "legMode")
          ) %>%
  `colnames<-`(c("mode", "modechoice", "legmode")) %>%
  mutate(
    replans = modechoice - legmode,
    replan_pct = replans / modechoice
  )
modeComparison %>%
  my_kbl(digits = 3, align = 'lrrrr')
```

Interestingly, the number of `Replanning` events is lower than the sum of the `replans` column above:
```{r}
events %>%
  filter(type == "Replanning") %>%
  nrow()

modeComparison$replans %>% sum()
```

As it turns out, some people have their day "cut short": they choose a mode but don't arrive at their next event by the end of the simulation:
```{r}
events %>%
  filter(person == personModefail) %>%
  tail(n = 10) %>%
  select(1:5)
```


### Ridehail Stats

We can look at some of the stats pertaining to ridehail vehicles:
```{r}
rhPassengers <- events %>%
  filter(type == "PathTraversal",
         vehicleType == "micro"
         ) %>%
  select(numPassengers) %>%
  table() %>%
  as_tibble() %>%
  `colnames<-`(c("numPassengers", "n")) %>%
  mutate(pct = n / sum(n))
rhPassengers %>%
  my_kbl(digits = 2, align = 'lrr', caption = "Trips by Occupancy")

totRiders <- sum(as.integer(rhPassengers$numPassengers) * rhPassengers$n)
totRiders  

utilization <- totRiders / rhHours / rhNum
utilization

events %>%
  filter(type == "PathTraversal",
         vehicleType == "micro"
         ) %>%
  select(numPassengers, travelTime) %>%
  group_by(numPassengers) %>%
  summarise(
    mean = mean(travelTime) / 60,
    median = median(travelTime) /60,
    min = min(travelTime) / 60,
    max = max(travelTime) / 60
  ) %>%
  my_kbl(digits = 2, align = 'lrrr', caption = "Travel Times by Occupancy (min)")
```

We can also look at the average time between reserving a ridehail and the next event, whether that's entering the ridehail or replanning and choosing a different mode (note that times are given in minutes):
```{r}
rhTimes <- events %>%
  arrange(person, time) %>%
  mutate(
    rhReserveTime = ifelse(
      type == "ReserveRideHail" & person == lead(person),
      lead(time) - time,
      NA
      ),
    rhReserveOutcome = ifelse(
      type == "ReserveRideHail" & person == lead(person),
      lead(type),
      NA
      )
  ) %>%
  filter(!is.na(rhReserveTime))

rhTimes %>%
  group_by(rhReserveOutcome) %>%
  summarise(
    mean = mean(rhReserveTime) / 60,
    median = median(rhReserveTime) /60,
    min = min(rhReserveTime) / 60,
    max = max(rhReserveTime) / 60
    ) %>%
  my_kbl(digits = 2, caption = "RideHail Reservation Outcomes", align = 'lrrr') %>%
  add_header_above(c(" " = 1, "Time until outcome (min)" = 4))
```



### Travel Times

We can also look at travel times (again in minutes):
```{r}
events %>%
  filter(!is.na(travelTime)) %>%
  mutate(travelTime = travelTime / 60) %>% 
  group_by(vehicleType) %>%
  boxplot(travelTime ~ vehicleType,
          data = .,
          horizontal = T)
```

We may have some issues related to routing and/or since it seems people are willing to walk upwards of 20 hours. However, we can still look at subsets of the data:
```{r}
events %>%
  filter(!is.na(travelTime),
         !grepl("BODY", vehicleType)
         ) %>%
  mutate(travelTime = travelTime / 60) %>% 
  group_by(vehicleType) %>%
  boxplot(travelTime ~ vehicleType,
          data = .,
          horizontal = T)

events %>%
  filter(!is.na(travelTime),
         !grepl("BODY", vehicleType),
         travelTime < (3 * 3600)
         ) %>%
  mutate(travelTime = travelTime / 60) %>% 
  group_by(vehicleType) %>%
  boxplot(travelTime ~ vehicleType,
          data = .,
          horizontal = T)
```

