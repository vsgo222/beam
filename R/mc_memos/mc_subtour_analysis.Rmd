---
title: "Subtour Analysis"
author: "Chris Day"
date: "2/21/2022"
output: html_document
---

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
source("subtour_functions.R")
```

## Introduction
Part of my thesis will be comparing the mode choice of ASIM vs BEAM. A way of comparing these things is to see how both determine modes on subtours. We are going to compare the two in this memo. 

In order to complete this comparison, we must first determine which trips in our plans are subtours. Since the activity orders / plans are identical between all iterations of BEAM, we can simply use the ASIM final_trips as a base for determining subtours. Then, once subtours are determined on the trip output of ASIM, we can merge the mode choices of the final BEAM output onto it. This way we can compare the modes between ASIM and BEAM on the subtour level.

As summary of what was just explained can be seen below:

  - ASIM --> final_trips.csv (trip output of ActivitySim)
  - BEAM --> final_events.csv (TripArrivalEvents from BEAM events)
  
In addition, as is briefly mentioned above, a new event was created in the BEAM framework called the TripArrivalEvent. This shows all the trip statistics as an agent is arriving at their activity. This event, from the output events file will be used to help merge the BEAm results onto the ASIM subtour data table. 

## ASIM Subtour Determination
Using the final trip outputs from ActivitySim, we can determine the subtours of each tour in the data.To do this we first read in the data table.

```{r, message=FALSE, warning=FALSE}
asim_final_trips <- read_csv("events/final_trips.csv") %>%
  filter(person_id< 5000) %>%
  select(trip_id, person_id, tour_id, trip_num, trip_count, purpose, origin, destination, trip_mode)
```

Now, using the functions in the R script, we manipulate the dataset to determine the subtours on a purpose based level. This is done below.

```{r}
work_subtours <- 
  get_purpose_subtours(asim_final_trips,"work") %>%
  mutate(work_subtours = sub) %>% select(-sub)
univ_subtours <- 
  get_purpose_subtours(asim_final_trips,"univ") %>%
  mutate(univ_subtours = sub) %>% select(-sub)
school_subtours <- 
  get_purpose_subtours(asim_final_trips,"school") %>%
  mutate(school_subtours = sub) %>% select(-sub)
escort_subtours <- 
  get_purpose_subtours(asim_final_trips,"escort") %>%
  mutate(escort_subtours = sub) %>% select(-sub)
shopping_subtours <-   
  get_purpose_subtours(asim_final_trips,"shopping") %>%
  mutate(shopping_subtours = sub) %>% select(-sub)
eatout_subtours <- 
  get_purpose_subtours(asim_final_trips,"eatout") %>%
  mutate(eatout_subtours = sub) %>% select(-sub)
othmaint_subtours <- 
  get_purpose_subtours(asim_final_trips,"othmaint") %>%
  mutate(othmaint_subtours = sub) %>% select(-sub)
social_subtours <- 
  get_purpose_subtours(asim_final_trips,"social") %>%
  mutate(social_subtours = sub) %>% select(-sub)
othdiscr_subtours <- 
  get_purpose_subtours(asim_final_trips,"othdiscr") %>%
  mutate(othdiscr_subtours = sub) %>% select(-sub)
atwork_subtours <- 
  get_purpose_subtours(asim_final_trips,"atwork") %>%
  mutate(atwork_subtours = sub) %>% select(-sub)
```

Next, we merge together all the above tables to create one subtour column, each describing which type of subtour it is. 

```{r}
#merge tables here
subtour_purps <- merge_subtours(
  work_subtours,
  univ_subtours,
  school_subtours,
  escort_subtours,
  shopping_subtours,
  eatout_subtours,
  othmaint_subtours,
  social_subtours,
  othdiscr_subtours,
  atwork_subtours
)
```




## BEAM Events

```{r}
csvevents2.5k <- read_csv("events/slc-light-csv-test__2022-02-21_09-45-10_mqc/ITERS/it.1/1.events.csv", col_types = cols(.default = "c")) %>%
  filter(type == "TripArrivalEvent") %>%
  select(person,time,type,mode,currentTourMode,income,vehicleOwnership,length,tourIndex,tourPurpose,activityIndex,actType,locationX,locationY)
```

```{r}
tripArrivals <- csvevents2.5k %>%
  arrange(person,tourIndex,activityIndex) %>%
  select(person,tourIndex,activityIndex,actType,locationX,locationY,mode)
```


